<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="/scripts/scripts.js"></script>
    <script src="/scripts/index.js" defer></script>
    <script src="/scripts/bootstrap.bundle.min.js"></script>
    <link rel='stylesheet' href='/stylesheets/style.css'/>
    <link rel='stylesheet' href="/stylesheets/timeline.css"/>
    <link rel='stylesheet' href='/stylesheets/bootstrap.min.css'/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
</head>
<body onload="initPostsApp()">
<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="/#">myStory</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
            aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="/">View Posts<span class="sr-only">(current)</span></a>
            </li>
            <!--TODO: Have this hide and show correctly based on user log-in status-->
            <li class="nav-item">
                <a class="nav-link" href="/timeline">View Your Posts</a>
            </li>
        </ul>
        <span>
            <!--TODO: Have these hide and show correctly based on user log-in status-->
            <button class="btn btn-outline-secondary" type="button"
                    onclick="window.location.href='logout'">Logout
            </button>
            <button class="btn btn-outline-secondary" type="button" onclick="window.location.href='createPost'">Submit Post</button>
        </span>
    </div>
</nav>
<div class="offline_div" id="offline_div" style="display: none">You are offline</div>

<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="/#">myStory</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
            aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="/">View Posts<span class="sr-only">(current)</span></a>
            </li>
            <!--TODO: Have this hide and show correctly based on user log-in status-->
            <li class="nav-item">
                <a class="nav-link" href="/timeline">View Your Posts</a>
            </li>
        </ul>
        <span>
              <!--TODO: Have these hide and show correctly based on user log-in status-->
              <button class="btn btn-outline-secondary" type="button"
                      onclick="window.location.href='logout'">Logout</button>
              <button class="btn btn-outline-secondary" type="button" onclick="window.location.href='createPost'">Submit Post</button>
            </span>
    </div>
</nav>
<div class="offline_div" id="offline_div" style="display: none">You are offline</div>
<div class="container">
    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
            Order by
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <button class="dropdown-item" type="button">Date</button>
            <button class="dropdown-item" type="button">Recommended</button>
        </div>
    </div>
    <br>
    <% allStories %>
    <div class="hidden" id="currentUser" style="display: none;">
        <%= req.session.user._id %>
    </div>
    <!----------------
          FIXME: To allow stories to be liked/edited we need to be able to retrieve the IDs associated with each story
           These will then be used to amend the "id" attribute of the card tags
           timeline.js is already set up to identify stories based on the ID of the card (to be edited slightly for index.js)
       ------------------>
    <% for(let i = (allStories.length - 1); i > 0; i--) { %>
        <div class="card body-card" id="<%= allStories[i]._id %>">
            <div class="card-header">
                <div class="" id="profileArea">
                    <div id="userName">
                        <% if((allStories[i].user_id) === undefined) { %>
                            Unknown User
                        <% } else { %>
                            <%= allStories[i].user_id; %>
                        <% } %>

                    </div>
                    <div id="timePosted" style="padding-top: 10px;">
                        <%= allStories[i].date %>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <p class="storyText" id="textID1"><%= allStories[i].text %></p>
                <div id="results"></div>
                <div class="row">
                    <!----------------
                       TODO: The src of these img tags needs to be fixed to display images properly
                        The arg parsed from JS is the buffer from the DB,
                        I am unsure how this is encoded/how to use it to create an image
                    ------------------>
                    <% if(allStories[i].image.length !== 0) { %>

                        <% if(allStories[i].image.length === 1) { %>
                            <div class="col-md-4">
                                <img src="data:image/jpeg;base64,  <%= allStories[i].image.toString('base64'); %>"
                                     alt="inn_logo" class="img-fluid">
                            </div>
                        <% } else { %>
                            <div class="col-md-<%= (12 / allStories[i].image.length) %>">
                                <img src="data:image/jpeg;base64,  <%= allStories[i].image.toString('base64'); %>"
                                     alt="inn_logo" class="img-fluid">
                            </div>
                            <div class="col-md-<%= (12 / allStories[i].image.length) %>">
                                <img src="data:image/jpeg;base64,  <%= allStories[i].image.toString('base64'); %>"
                                     alt="inn_logo" class="img-fluid">
                            </div>
                        <% } %>
                        <% if(allStories[i].image.length == 3){ %>
                            <div class="col-md-<%= (12 / allStories[i].image.length) %>">
                                <img src="data:image/jpeg;base64,  <%= allStories[i].image.toString('base64'); %>"
                                     alt="inn_logo" class="img-fluid">
                            </div>
                        <% } %>
                    <% } %>
                </div>

            </div>
            <div class="card-footer" style="display: inline-block;">
                <div class="row">
                    <div class="col-md-3">
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown"
                                    id="likeDropDown<%= allStories[i]._id %>" aria-haspopup="true"
                                    aria-expanded="false">
                                Like
                            </button>
                            <div class="dropdown-menu" id="like<%= allStories[i]._id %>">
                                <button class="dropdown-item likeButtons" id="like5" type="button">5 - I love this!
                                </button>
                                <button class="dropdown-item likeButtons" id="like4" type="button">4 - I like this a
                                    lot
                                </button>
                                <button class="dropdown-item likeButtons" id="like3" type="button">3 - I like this
                                </button>
                                <button class="dropdown-item likeButtons" id="like2" type="button">2 - I dislike this
                                </button>
                                <button class="dropdown-item likeButtons" id="like1" type="button">1 - I strongly
                                    dislike this!
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="" id="averageRating">
                            Average like rating: <%= allStories[i].averageRating %>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div>
                            Liked by <%= allStories[i].likeCount%> users
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <% } %>
</div>
</body>
</html>
